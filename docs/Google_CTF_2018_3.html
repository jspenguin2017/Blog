<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="author" content="jspenguin2017" />

    <meta http-equiv="Content-Security-Policy" content="default-src 'self';" />
    <meta name="referrer" content="no-referrer" />
    <title>(TODO) - Hugo Xu</title>

    <link rel="stylesheet" href="common.css" />
    <link rel="stylesheet" href="page.css" />
</head>
<body>
    <div class="navbar">
        <div class="left">
            <a class="title">Hugo Xu</a>
            <a class="item" href="index.html">Home</a>
        </div>
        <div class="clear"></div>
    </div>

    <div class="container"><h1 id="titletodo">(Title TODO)</h1>
<p>(Intro TODO)</p>
<h2 id="gatekeeper">Gatekeeper</h2>
<p>Only a file named <code>gatekeeper</code> is insize the ZIP attachment, what's it?</p>
<pre><code>$ file gatekeeper
gatekeeper: ELF 64-bit LSB shared object, x86-64, [...], not stripped
$ ./gatekeeper
/===========================================================================\
|               Gatekeeper - Access your PC from everywhere!                |
+===========================================================================+
[ERROR] Login information missing
Usage: ./gatekeeper &lt;username&gt; &lt;password&gt;
</code></pre>
<p>It's usually a good idea to see what strings are embedded in the binary:</p>
<pre><code>$ strings gatekeeper
[...]
 ~&gt; Verifying.
0n3_W4rM
 ~&gt; Incorrect username
zLl1ks_d4m_T0g_I
Correct!
[...]
$ ./gatekeeper 0n3_W4rM zLl1ks_d4m_T0g_I
/===========================================================================\
|               Gatekeeper - Access your PC from everywhere!                |
+===========================================================================+
 ~&gt; Verifying.......ACCESS DENIED
 ~&gt; Incorrect password
</code></pre>
<p>Finding the fishy strings weren't too hard, but they don't work. After staring
at the second string a few seconds, it reads <code>I got mad skills</code> backward. Is
that it?</p>
<pre><code>$ ./gatekeeper 0n3_W4rM I_g0T_m4d_sk1lLz
/===========================================================================\
|               Gatekeeper - Access your PC from everywhere!                |
+===========================================================================+
 ~&gt; Verifying.......Correct!
Welcome back!
CTF{I_g0T_m4d_sk1lLz}
</code></pre>
<p>Yep, that's it.</p>
<h2 id="adminui2">Admin UI 2</h2>
<p>It's time to log in using the flag from <a href="Google_CTF_2018_2.html">last time</a>:</p>
<pre><code>[...]
1
Please enter the backdoo^Wservice password:

CTF{I_luv_buggy_sOFtware}
! Two factor authentication required !
Please enter secret secondary password:
</code></pre>
<p>Eh… Let's dump the binary as per hints from the quest prompt:</p>
<pre><code>$ echo -e "2\n../../../proc/self/exe\n3" | nc mngmnt-iface.ctfcompetition.com 1337 &gt; data.bin
</code></pre>
<p>This would include the menu text as well, I cleaned them with a text editor.
Surprisingly that didn't corrupt the binary. Hopper Disassembler can generate
C style pseudocode from binary:</p>
<pre><code>int _Z15secondary_loginv() {
    puts("! Two factor authentication required !");
    puts("Please enter secret secondary password:");
    scanf("%127s", &amp;var_90);
    rax = strlen(&amp;var_90);
    var_10 = rax;
    for (var_8 = 0x0; var_8 &lt; var_10; var_8 = var_8 + 0x1) {
            *(int8_t *)(var_8 + &amp;var_90) = *(int8_t *)(var_8 + &amp;var_90) &amp; 0xff ^ 0xffffffc7;
    }
    if (var_10 == 0x23) {
            var_90 = *FLAG;
            if (&amp;var_90 != 0x0) {
                    rax = 0x1;
            }
            else {
                    rax = 0x0;
            }
    }
    else {
            rax = 0x0;
    }
    if (rax != 0x0) {
            puts("Authenticated");
            rax = command_line();
    }
    else {
            puts("Access denied.");
            rax = exit(0x1);
    }
    return rax;
}
</code></pre>
<p>It didn't take long to find the function responsible for two factor
authentication, but the code still needs some cleaning:</p>
<pre><code>function secondary_login() {
    print(prompt_text);

    char_array user_input = read_up_to_chars(127);
    for (int i = 0; i &lt; get_length(user_input); i++)
        user_input[i] = user_input[i] ^ 0xc7;

    bool good;
    if (get_length(uer_input) == 0x23) {
        char_array flag = find_char_array(FLAG);
        if (found_char_array(flag))
            good = true;
        else
            good = false;
    } else {
        good = false;
    }

    if (good) {
        print("Authenticated");
        command_line();
    } else {
        print("Access denied.");
        exit_with_error(1);
    }
}
</code></pre>
<p>It's not valid C code, but the idea is easy to see. The secondary password can
be any string that is <code>0x23</code> or <code>35</code> characters long. I'll just use 35 <code>a</code>:</p>
<pre><code>[...]
! Two factor authentication required !
Please enter secret secondary password:
aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa
Authenticated

&gt; shell
Security made us disable the shell, sorry!
</code></pre>
<p>Well, looks like I need to find another way. Looking back at the
<code>secondary_login</code> function, the XOR and the <code>FLAG</code> variables are extra
suspicious, what's the content of <code>FLAG</code>?</p>
<pre><code class="JavaScript language-JavaScript">"use strict";

const flag = [
    [
        0x98, 0xa8, 0xb0, 0x93,
        0xbc, 0x81, 0x93, 0x84,
    ],
    [
        0x83, 0xb5, 0xa8, 0xb0,
        0x94, 0xb4, 0xa6, 0x97,
    ],
    [
        0xb5, 0xa2, 0xb3, 0xb3,
        0xa2, 0x85, 0x98, 0xbd,
    ],
    [
        0x98, 0xf6, 0x98, 0xa9,
        0xf3, 0xaf, 0xb3, 0x98,
    ],
    [
        0xf8, 0xac,
    ],
    [
        0xba,
    ],
];

for (const w of flag) {
    let i = w.length;
    while (i--) { // Takes care of endianness
        process.stdout.write(String.fromCharCode(w[i] ^ 0xc7));
    }
}
</code></pre>
<p>The content can be easily read out from Hopper Disassembler, but it's not
readable text. However, it's clearly the flag after XOR-ing each byte with
<code>0xc7</code>: <code>CTF{Two_PasSworDz_Better_th4n_1_k?}</code>.</p>
<p>I'm not sure if it's a bug or intentional, but it would make more sense if the
<code>secondary_login</code> function actually validated the input. <code>shell</code> is disabled,
but can it be enabled with some hacking?</p></div>

    <div class="container footer">
        <p>By Hugo Xu (@jspenguin2017)</p>
    </div>
</body>
</html>
